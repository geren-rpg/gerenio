<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciador de Personagens (Pixel Art)</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Pixel Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <style>
    /* Fundo Pixel Art */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px);
  z-index: -1;
  pointer-events: none;
}

/* Estrelas animadas para modo escuro */
body:not(.light-mode)::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(2px 2px at 20% 30%, white, transparent),
    radial-gradient(2px 2px at 60% 70%, white, transparent),
    radial-gradient(1px 1px at 50% 50%, white, transparent),
    radial-gradient(1px 1px at 80% 10%, white, transparent),
    radial-gradient(2px 2px at 90% 60%, white, transparent),
    radial-gradient(1px 1px at 30% 80%, white, transparent),
    radial-gradient(1px 1px at 70% 40%, white, transparent),
    radial-gradient(2px 2px at 40% 20%, white, transparent),
    radial-gradient(1px 1px at 10% 90%, white, transparent),
    radial-gradient(1px 1px at 95% 30%, white, transparent);
  background-size: 
    200% 200%,
    180% 180%,
    250% 250%,
    220% 220%,
    190% 190%,
    240% 240%,
    210% 210%,
    230% 230%,
    260% 260%,
    170% 170%;
  background-position: 
    0% 0%,
    20% 20%,
    40% 40%,
    60% 60%,
    80% 80%,
    100% 100%,
    120% 120%,
    140% 140%,
    160% 160%,
    180% 180%;
  z-index: -1;
  pointer-events: none;
  opacity: 0.4;
  animation: starsMove 120s linear infinite;
}

/* Part√≠culas flutuantes para modo claro */
body.light-mode::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(255, 190, 11, 0.3) 0%, transparent 2%),
    radial-gradient(circle at 40% 40%, rgba(255, 0, 110, 0.2) 0%, transparent 2%),
    radial-gradient(circle at 60% 60%, rgba(0, 217, 255, 0.2) 0%, transparent 2%),
    radial-gradient(circle at 80% 20%, rgba(157, 78, 221, 0.2) 0%, transparent 2%),
    radial-gradient(circle at 10% 30%, rgba(255, 190, 11, 0.2) 0%, transparent 2%),
    radial-gradient(circle at 90% 70%, rgba(255, 0, 110, 0.3) 0%, transparent 2%),
    radial-gradient(circle at 30% 90%, rgba(0, 217, 255, 0.3) 0%, transparent 2%),
    radial-gradient(circle at 70% 50%, rgba(157, 78, 221, 0.3) 0%, transparent 2%);
  background-size: 
    20px 20px,
    30px 30px,
    25px 25px,
    35px 35px,
    28px 28px,
    22px 22px,
    32px 32px,
    26px 26px;
  z-index: -1;
  pointer-events: none;
  animation: particlesFloat 60s linear infinite;
}

/* Anima√ß√£o das estrelas */
@keyframes starsMove {
  0% {
    background-position: 
      0% 0%,
      20% 20%,
      40% 40%,
      60% 60%,
      80% 80%,
      100% 100%,
      120% 120%,
      140% 140%,
      160% 160%,
      180% 180%;
  }
  100% {
    background-position: 
      200% 200%,
      220% 220%,
      240% 240%,
      260% 260%,
      280% 280%,
      300% 300%,
      320% 320%,
      340% 340%,
      360% 360%,
      380% 380%;
  }
}

/* Anima√ß√£o das part√≠culas */
@keyframes particlesFloat {
  0% {
    transform: translateY(0) translateX(0);
  }
  25% {
    transform: translateY(-50px) translateX(20px);
  }
  50% {
    transform: translateY(0) translateX(40px);
  }
  75% {
    transform: translateY(110px) translateX(10px);
  }
  100% {
    transform: translateY(0) translateX(0);
  }
}

/* Remover a anima√ß√£o pulseGlow antiga */
/* @keyframes pulseGlow foi removida */
    /* Vari√°veis Pixel Art */
    :root {
      --bg-dark: #1a1a2e;
      --bg-darker: #0f0f1e;
      --card-bg: #16213e;
      --text-primary: #a0a0a0c5;
      --text-secondary: #a4a4a4;
      --accent-1: #00d9ff;
      --accent-2: #ff006e;
      --accent-3: #ffbe0b;
      --hp-color: #ff0000;
      --armor-color: #08a4ff;
      --mana-color: #a83eff;
      --border-width: 4px;
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;    
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* Light Mode */
    body.light-mode {
      --bg-dark: #f0e6d2;
      --bg-darker: #e8dcc0;
      --card-bg: #ffffff;
      --text-primary: #2d2d2d;
      --text-secondary: #666666;
    }

    /* Fundo Pixel Art */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px);
      z-index: -1;
      pointer-events: none;
    }

    body:not(.light-mode)::after {
      content: '';
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(157, 78, 221, 0.1) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
      animation: pulseGlow 8s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    /* Borda Pixel Art */
    .pixel-border {
      border: var(--border-width) solid var(--text-primary);
      box-shadow: 
        0 0 0 calc(var(--border-width) * 2) var(--bg-darker),
        0 0 0 calc(var(--border-width) * 3) var(--text-primary);
      position: relative;
    }

    .pixel-border::before {
      content: '';
      position: absolute;
      top: calc(var(--border-width) * -1);
      left: calc(var(--border-width) * -1);
      right: calc(var(--border-width) * -1);
      bottom: calc(var(--border-width) * -1);
      border: var(--border-width) solid var(--bg-darker);
      pointer-events: none;
    }

    /* Cards */
    .rpg-card {
      background-color: var(--card-bg);
      color: var(--text-primary);
      border: 4px solid var(--text-primary);
      box-shadow: 8px 8px 0 rgba(0,0,0,0.3);
      transition: transform 0.1s, box-shadow 0.1s;
      position: relative;
    }

    .rpg-card:hover {
      transform: translate(-2px, -2px);
      box-shadow: 10px 10px 0 rgba(0,0,0,0.4);
    }

    /* Drag States */
    .rpg-card.dragging {
      opacity: 0.9;
      transform: scale(1.05) rotate(-2deg);
      box-shadow: 12px 12px 0 rgba(0,0,0,0.5);
      z-index: 100;
    }

    .rpg-card.dragover {
      outline: 4px dashed var(--accent-1);
      outline-offset: 4px;
    }

    .rpg-card.moved { 
      animation: pixelPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .rpg-card.damaged {
      animation: pixelShake 0.4s;
      box-shadow: 0 0 0 4px var(--hp-color), 8px 8px 0 rgba(0,0,0,0.3);
    }

    @keyframes pixelPop {
      0% { transform: scale(0.95); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    @keyframes pixelShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }

    /* Ghost Element */
    .ghost-follow {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.85;
      transform: translate(-50%, -50%) rotate(-3deg);
      filter: drop-shadow(8px 8px 0 rgba(0,0,0,0.5));
    }

    /* Bot√µes Flutuantes Pixel */
    .icon-btn-float {
      position: absolute;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-1);
      color: var(--bg-dark);
      cursor: pointer;
      border: 3px solid var(--text-primary);
      box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
      transition: all 0.1s;
      z-index: 10;
      font-size: 16px;
    }

    .icon-btn-float:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
    }

    .icon-btn-float:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    .edit-btn { 
      right: 12px; 
      top: 12px; 
      background: var(--accent-3);
    }

    .res-btn { 
      right: 56px; 
      top: 12px; 
      background: var(--accent-2);
    }

    /* Pills Pixel */
    .action-pill {
      background-color: var(--bg-darker);
      color: var(--text-primary);
      border: 3px solid var(--text-primary);
      cursor: pointer;
      transition: all 0.1s;
      user-select: none;
      font-size: 12px;
      padding: 8px !important;
      text-align: center;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
    }

    .action-pill:hover {
      transform: translate(-2px, -2px);
      background: var(--accent-1);
      color: var(--bg-dark);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
    }

    .action-pill:active {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }

    /* Barras de Progresso Pixel */
    .progress {
      background-color: var(--bg-darker);
      border: 3px solid var(--text-primary);
      height: 20px !important;
      border-radius: 0 !important;
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.3);
      overflow: visible;
    }

    .progress-bar {
      border-radius: 0 !important;
      box-shadow: inset -2px -2px 0 rgba(255,255,255,0.2);
      position: relative;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 4px,
        rgba(0,0,0,0.1) 4px,
        rgba(0,0,0,0.1) 8px
      );
    }

    .bg-hp { background: var(--hp-color) !important; }
    .bg-armor { background: var(--armor-color) !important; }
    .bg-mana { background: var(--mana-color) !important; }

    /* Modals Pixel */
    .custom-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      z-index: 1050;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .custom-modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .custom-modal-panel {
      background: var(--card-bg);
      color: var(--text-primary);
      width: 100%;
      max-width: 500px;
      border: 4px solid var(--text-primary);
      box-shadow: 12px 12px 0 rgba(0,0,0,0.5);
      transform: scale(0.9);
      transition: transform 0.2s;
    }

    .custom-modal-overlay.show .custom-modal-panel {
      transform: scale(1);
    }

    /* Form Controls Pixel */
    .form-control-custom, .form-select-custom {
      background-color: var(--bg-darker);
      border: 3px solid var(--text-primary) !important;
      color: var(--text-primary);
      border-radius: 0 !important;
      font-family: 'Press Start 2P', cursive;
      font-size: 16px;
      padding: 8px;
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.2);
    }

    .form-control-custom:focus {
      background-color: var(--bg-darker);
      color: var(--text-primary);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.2), 0 0 0 4px var(--accent-1) !important;
      border-color: var(--text-primary) !important;
    }

    /* Bot√µes Pixel */
    .btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 13px;
      border-radius: 0 !important;
      border: 3px solid var(--text-primary) !important;
      padding: 8px 16px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
      transition: all 0.1s;
    }

    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
    }

    .btn:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    .btn-primary {
      background-color: var(--accent-1) !important;
      color: var(--bg-dark) !important;
    }

    .btn-danger {
      background-color: var(--hp-color) !important;
      color: white !important;
    }

    .btn-outline-secondary {
      background-color: var(--bg-darker);
      color: var(--text-primary);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.3) !important;
    }

    /* Card Title */
    .card-title {
      font-size: 17px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
    }

    /* Text Sizes */
    .small, .text-muted {
      color: rgb(189, 189, 189) !important;
      font-size: 11px !important;
    }

    h3, .h4 {
      font-size: 14px;
      text-transform: uppercase;
    }

    h5 {
      font-size: 10px;
      text-transform: uppercase;
    }

    /* List Group Pixel */
    .list-group-item-custom {
      background-color: var(--bg-darker);
      color: var(--text-primary);
      border: 3px solid var(--text-primary) !important;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 8px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
      transition: all 0.1s;
      border-radius: 0 !important;
    }

    .list-group-item-custom:hover {
      transform: translate(-2px, -2px);
      background-color: var(--accent-1);
      color: var(--bg-dark);
      box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
    }

    /* Badge Pixel */
    .badge {
      border: 2px solid var(--text-primary);
      border-radius: 0 !important;
      font-size: 13px;
      padding: 4px 8px;
    }

    /* Switch Pixel */
    .form-check-input {
      width: 48px;
      height: 24px;
      border: 3px solid var(--text-primary) !important;
      border-radius: 0 !important;
      background-color: var(--bg-darker);
      cursor: pointer;
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.2);
    }

    .form-check-input:checked {
      background-color: var(--accent-1) !important;
    }

    /* Toast Pixel */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
    }

    .toast {
      border: 4px solid var(--text-primary) !important;
      border-radius: 0 !important;
      box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
      font-size: 10px;
      font-family: 'Press Start 2P', cursive;
    }

    /* Alert Pixel */
    .alert {
      border: 3px solid var(--text-primary) !important;
      border-radius: 0 !important;
      font-size: 10px;
    }

    /* Drag Handle */
    .drag-handle {
      cursor: grab;
      padding-right: 90px !important;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    /* Label Pixel */
    .form-label {
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Container Ajuste */
    .container {
      max-width: 1200px;
    }

    /* Card Body Padding */
    .card-body {
      padding: 16px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .card-title {
        font-size: 10px;
      }
      
      .btn {
        font-size: 8px;
        padding: 6px 12px;
      }
      
      .action-pill {
        font-size: 8px;
      }
    }
  </style>
</head>
<body>
  
  <div id="toast-container"></div>

  <div class="container py-4">
    <!-- Header -->
    <header class="mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-md">
          <input id="search" type="search" class="form-control form-control-custom form-control-lg" placeholder="BUSCAR..." />
        </div>
        <div class="col-12 col-md-auto d-flex gap-2 align-items-center justify-content-end flex-wrap">
          <button id="undoBtn" class="btn btn-outline-secondary">DESFAZER</button>
          <button id="redoBtn" class="btn btn-outline-secondary">REFAZER</button>
          <button id="createBtn" class="btn btn-primary fw-bold">CRIAR</button>
          
          <div class="form-check form-switch ms-2">
            <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
          </div>
        </div>
      </div>
    </header>

    <!-- Main Grid -->
    <main id="cards" class="row g-4" aria-label="Lista de personagens">
      <!-- Cards ser√£o injetados aqui -->
    </main>
  </div>

  <!-- Modal Editar/Criar -->
  <div id="modal" class="custom-modal-overlay">
    <div class="custom-modal-panel p-4">
      <h3 id="modalTitle" class="mb-3 h4">EDITAR</h3>
      
      <div class="mb-3">
        <label class="form-label text-muted small">NOME</label>
        <input id="mName" class="form-control form-control-custom" />
      </div>

      <div class="row g-2 mb-3">
        <div class="col-4">
          <label class="form-label text-muted small">VIDA MAX</label>
          <input id="mMaxHp" type="number" class="form-control form-control-custom" />
        </div>
        <div class="col-4">
          <label class="form-label text-muted small">DEFESA</label>
          <input id="mDefense" type="number" class="form-control form-control-custom" />
        </div>
        <div class="col-4">
          <label class="form-label text-muted small">REGEN %</label>
          <input id="mRegenPercent" type="number" min="0" max="100" class="form-control form-control-custom" />
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-6">
          <label class="form-label text-muted small">ARMOR MAX</label>
          <input id="mMaxArmor" type="number" class="form-control form-control-custom" />
        </div>
        <div class="col-6">
          <label class="form-label text-muted small">MANA MAX</label>
          <input id="mMaxMana" type="number" class="form-control form-control-custom" />
        </div>
      </div>
      
      <h5 class="mt-4 mb-3 d-flex align-items-center gap-2 text-info"><span>üíä</span> RESIST</h5>
      <div id="mResistances" class="row g-2"></div>

      <div class="d-flex gap-2 mt-4 justify-content-end flex-wrap">
        <button id="deleteBtn" class="btn btn-danger me-auto" style="display:none">DEL</button>
        <button id="cancelModal" class="btn btn-outline-secondary">CANCELAR</button>
        <button id="saveModal" class="btn btn-primary">SAVE</button>
      </div>
    </div>
  </div>

  <!-- Modal A√ß√µes -->
  <div id="actionModal" class="custom-modal-overlay">
    <div class="custom-modal-panel p-4">
      <h3 id="actionTitle" class="mb-3 h4">ACAO</h3>
      <div id="actionBody"></div>
      <div class="d-flex gap-2 mt-4 justify-content-end flex-wrap">
        <button id="cancelAction" class="btn btn-outline-secondary">CANCELAR</button>
        <button id="confirmAction" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Lista Resist√™ncias -->
  <div id="resistanceModal" class="custom-modal-overlay">
    <div class="custom-modal-panel p-4">
      <h3 id="resistanceModalTitle" class="mb-3 h4">RESIST</h3>
      <div id="resistanceModalBody" class="list-group"></div>
      <div class="d-flex justify-content-end mt-3">
        <button id="closeResistanceModal" class="btn btn-outline-secondary">FECHAR</button>
      </div>
    </div>
  </div>
  
  <!-- Modal A√ß√£o Resist√™ncia -->
  <div id="resistanceActionModal" class="custom-modal-overlay">
    <div class="custom-modal-panel p-4">
      <h3 id="resistanceActionTitle" class="mb-3 h4">GERENCIAR</h3>
      <label class="form-label text-muted small">VALOR</label>
      <input id="resAmount" type="number" value="0" class="form-control form-control-custom mb-3" />
      
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <button id="resSet" class="btn btn-outline-secondary flex-fill">SETAR</button>
        <button id="resAdd" class="btn btn-primary flex-fill">ADICIONAR</button>
        <button id="resRemove" class="btn btn-danger flex-fill">SUBTRAIR</button>
      </div>
      <div class="mt-2">
        <button id="cancelResAction" class="btn btn-outline-secondary w-100">CANCELAR</button>
      </div>
    </div>
  </div>

  <footer class="text-center text-muted small py-4"></footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const STORAGE_KEY = 'rpg_chars_v1'
    const defaultChars = [
      {id:1,name:'Shizu',hp:143,maxHp:143,armor:117,maxArmor:117,mana:200,maxMana:200,regenPercent:20, defense: 0},
      {id:2,name:'Teste',hp:1000,maxHp:1000,armor:500,maxArmor:500,mana:300,maxMana:300,regenPercent:40, defense: 10}
    ]
    const resistanceTypes = ['Congelamento', 'Choque', 'Sangramento', 'Chamas', 'Veneno', 'Atordoamento', 'Cegueira'];

    function createDefaultResistances() {
        const resistances = {};
        resistanceTypes.forEach(type => {
            resistances[type] = { current: 0, max: 100 };
        });
        return resistances;
    }

    let chars = load() || defaultChars.slice()
    chars.forEach(c=>{ 
        if(!c.initial) c.initial = {
            hp:c.hp, armor:c.armor, mana:c.mana,
            maxHp:c.maxHp, maxArmor:c.maxArmor, maxMana:c.maxMana, 
            regenPercent:c.regenPercent||0,
            defense: c.defense || 0,
            resistances: c.resistances || createDefaultResistances()
        }
        if (!c.resistances) {
            c.resistances = createDefaultResistances();
        }
    })

    let editingId = null
    let activeResistanceContext = { id: null, type: null };

    const cardsEl = document.getElementById('cards')
    const searchEl = document.getElementById('search')
    const createBtn = document.getElementById('createBtn')
    const themeSwitch = document.getElementById('themeSwitch');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    const modal = document.getElementById('modal')
    const mName = document.getElementById('mName')
    const mMaxHp = document.getElementById('mMaxHp')
    const mMaxArmor = document.getElementById('mMaxArmor')
    const mMaxMana = document.getElementById('mMaxMana')
    const mRegenPercent = document.getElementById('mRegenPercent')
    const mDefense = document.getElementById('mDefense')
    const mResistances = document.getElementById('mResistances');
    const saveModal = document.getElementById('saveModal')
    const cancelModal = document.getElementById('cancelModal')
    const modalTitle = document.getElementById('modalTitle')
    const deleteBtn = document.getElementById('deleteBtn')

    const actionModal = document.getElementById('actionModal')
    const actionTitle = document.getElementById('actionTitle')
    const actionBody = document.getElementById('actionBody')
    const cancelAction = document.getElementById('cancelAction')
    const confirmAction = document.getElementById('confirmAction')
    
    const resistanceModal = document.getElementById('resistanceModal');
    const resistanceModalTitle = document.getElementById('resistanceModalTitle');
    const resistanceModalBody = document.getElementById('resistanceModalBody');
    const closeResistanceModal = document.getElementById('closeResistanceModal');
    const resistanceActionModal = document.getElementById('resistanceActionModal');
    const resistanceActionTitle = document.getElementById('resistanceActionTitle');
    const resAmount = document.getElementById('resAmount');
    const resSet = document.getElementById('resSet');
    const resAdd = document.getElementById('resAdd');
    const resRemove = document.getElementById('resRemove');
    const cancelResAction = document.getElementById('cancelResAction');

    let dragState = null 
    let history = [];
    let historyIndex = -1;
    const HISTORY_LIMIT = 6; 

    function render(){
      const q = (searchEl.value||'').trim().toLowerCase()
      cardsEl.innerHTML = ''
      const filtered = chars.filter(c => (c.name||'').toLowerCase().includes(q))
      if(filtered.length===0){ cardsEl.innerHTML = '<div class="col-12"><div class="alert alert-secondary">NENHUM CHAR ENCONTRADO</div></div>'; return }

      filtered.forEach((c,index)=>{
        const col = document.createElement('div')
        col.className = 'col-12 col-md-6 col-lg-4'
        
        const cardDiv = document.createElement('div')
        cardDiv.className = 'card rpg-card h-100'
        cardDiv.dataset.id = c.id
        cardDiv.dataset.index = index
        
        cardDiv.innerHTML = `
          <div class="card-body position-relative">
             <div class="icon-btn-float res-btn" data-id="${c.id}" title="Resist√™ncias">üíä</div>
             <div class="icon-btn-float edit-btn edit" data-id="${c.id}" title="Editar">‚úèÔ∏è</div>

            <h5 class="card-title drag-handle mb-3 fw-bold">${escapeHtml(c.name)}</h5>
            
            <div class="mb-2">
              <div class="d-flex justify-content-between small text-muted mb-1">
                <span>VIDA ‚ù§Ô∏è</span>
                <span>${c.hp}/${c.maxHp}</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-hp" role="progressbar" style="width: ${pct(c.hp,c.maxHp)}%"></div>
              </div>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between small text-muted mb-1">
                <span>ARMADURA üõ°Ô∏è</span>
                <span>${c.armor}/${c.maxArmor}</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-armor" role="progressbar" style="width: ${pct(c.armor,c.maxArmor)}%"></div>
              </div>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between small text-muted mb-1">
                <span>MANA ‚ú®</span>
                <span>${c.mana}/${c.maxMana}</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-mana" role="progressbar" style="width: ${pct(c.mana,c.maxMana)}%"></div>
              </div>
            </div>

            <div class="d-flex justify-content-between small text-muted mb-3">
                 <span>REGEN:${Number(c.regenPercent||0)}%</span>
                 <span>DEFESA:${c.defense || 0}</span>
            </div>

            <div class="row g-2">
              <div class="col-6"><div class="action-pill" data-act="dano" data-id="${c.id}">DANO üî•</div></div>
              <div class="col-6"><div class="action-pill" data-act="vida" data-id="${c.id}">VIDA ‚ù§Ô∏è</div></div>
              <div class="col-6"><div class="action-pill" data-act="armadura" data-id="${c.id}">ARMADURA üõ°Ô∏è</div></div>
              <div class="col-6"><div class="action-pill" data-act="mana" data-id="${c.id}">MANA ‚ú®</div></div>
              <div class="col-6"><div class="action-pill" data-act="regen" data-id="${c.id}">REGEN ‚ú®</div></div>
              <div class="col-6"><div class="action-pill" data-act="reset" data-id="${c.id}">RESETAR ‚ôªÔ∏è</div></div>
            </div>
          </div>
        `
        
        col.appendChild(cardDiv)
        cardsEl.appendChild(col)
        
        const handle = cardDiv.querySelector('.drag-handle')
        handle.addEventListener('pointerdown', onPointerDown)
      })

      document.querySelectorAll('.action-pill').forEach(el => {
        const act = el.dataset.act;
        const id = +el.dataset.id;
        if (act) {
             el.onclick = e => {
                if (act === 'regen') {
                    const c = chars.find(x => x.id === id);
                    if (!c) return;
                    const pct = Number(c.regenPercent || 0);
                    const amount = Math.round((c.maxMana || 0) * pct / 100);
                    applyAction(id, 'regen', amount, { allow: false });
                } else {
                    openAction(id, act);
                }
            }
        }
      });
      document.querySelectorAll('.edit').forEach(el=>el.onclick = e=>openEdit(+e.currentTarget.dataset.id))
      document.querySelectorAll('.res-btn').forEach(el=>el.onclick = e=>openResistanceModal(+e.currentTarget.dataset.id))
    }

    function onPointerDown(e){
      if(e.button !== 0) return
      const handle = e.currentTarget
      const card = handle.closest('.card') 
      const id = Number(card.dataset.id)
      card.setPointerCapture(e.pointerId)
      dragState = {id, originEl:card, pointerId:e.pointerId, targetId:null}
      const ghost = card.cloneNode(true)
      ghost.classList.add('ghost-follow')
      ghost.style.width = card.offsetWidth + 'px'
      ghost.style.height = card.offsetHeight + 'px'
      ghost.style.left = (e.clientX) + 'px'
      ghost.style.top = (e.clientY) + 'px'
      document.body.appendChild(ghost)
      dragState.ghostEl = ghost
      card.classList.add('dragging')
      window.addEventListener('pointermove', onPointerMove)
      window.addEventListener('pointerup', onPointerUp)
      e.preventDefault()
    }

    function onPointerMove(e){
      if(!dragState) return
      const {ghostEl, originEl} = dragState
      ghostEl.style.left = e.clientX + 'px'
      ghostEl.style.top = e.clientY + 'px'
      
      ghostEl.style.display = 'none';
      const el = document.elementFromPoint(e.clientX, e.clientY)
      ghostEl.style.display = '';

      const card = el ? el.closest && el.closest('.card') : null
      document.querySelectorAll('.card.dragover').forEach(n=>n.classList.remove('dragover'))
      dragState.targetId = null
      if(card && card !== originEl){
        card.classList.add('dragover')
        dragState.targetId = Number(card.dataset.id)
      }
    }

    function onPointerUp(e){
      if(!dragState) return
      const {originEl, ghostEl, id, targetId, pointerId} = dragState
      try{ originEl.releasePointerCapture(pointerId) }catch(_){}
      originEl.classList.remove('dragging')
      if(ghostEl && ghostEl.parentNode) ghostEl.parentNode.removeChild(ghostEl)
      document.querySelectorAll('.card.dragover').forEach(n=>n.classList.remove('dragover'))
      
      if(targetId != null && targetId !== id){
        const i1 = chars.findIndex(c=>c.id===id)
        const i2 = chars.findIndex(c=>c.id===targetId)
        if(i1>-1 && i2>-1){
          [chars[i1], chars[i2]] = [chars[i2], chars[i1]]
          commitChange(); 
          render();
          animateMovedCard(id); animateMovedCard(targetId)
        }
      }

      window.removeEventListener('pointermove', onPointerMove)
      window.removeEventListener('pointerup', onPointerUp)
      dragState = null
    }
    
    function animateDamage(id){
      requestAnimationFrame(()=>{
        const el = document.querySelector(`.card[data-id='${id}']`)
        if(!el) return
        el.classList.add('damaged')
        setTimeout(()=>el.classList.remove('damaged'), 420)
      })
    }

    function animateMovedCard(id){
      requestAnimationFrame(()=>{
        const el = document.querySelector(`.card[data-id='${id}']`)
        if(!el) return
        el.classList.add('moved')
        setTimeout(()=>el.classList.remove('moved'), 420)
      })
    }

    function pct(cur,max){ if(!max || max===0) return 0; return Math.max(0, Math.min(100, Math.round((cur/max)*100))) }
    function escapeHtml(t){ if(!t) return ''; return String(t).replace(/[&<>"']/g, c=>'&#'+c.charCodeAt(0)+';') }

    function openAction(id, act){
      const c = chars.find(x=>x.id===id)
      if(!c) return
      actionModal.classList.add('show')
      actionTitle.textContent = actLabel(act)
      actionBody.innerHTML = ''
      
      const info = document.createElement('div')
      info.className = 'alert alert-info py-2 d-flex align-items-center gap-2 mb-3'
      info.innerHTML = `<strong>${escapeHtml(c.name)}</strong>`
      actionBody.appendChild(info)

      if(act === 'dano'){
        actionBody.insertAdjacentHTML('beforeend', `
          <label class="form-label">QTD</label>
          <input id="aAmount" type="number" value="0" class="form-control form-control-custom mb-3" />
          <div class="form-check form-switch">
             <input class="form-check-input" type="checkbox" id="aTrue">
             <label class="form-check-label small" for="aTrue">DANO REAL</label>
          </div>
        `)
        confirmAction.onclick = ()=>{
          const x = Number(document.getElementById('aAmount').value) || 0
          const danoReal = document.getElementById('aTrue').checked
          applyAction(id,'dano',x,danoReal)
          closeAction()
        }
      } else if(act === 'reset'){
        actionBody.insertAdjacentHTML('beforeend', `<div class="alert alert-warning">RESETAR ${escapeHtml(c.name)}?</div>`)
        confirmAction.onclick = ()=>{ applyAction(id,'reset'); closeAction() }
      } else {
        actionBody.insertAdjacentHTML('beforeend', `
          <label class="form-label">OP</label>
          <select id="aOp" class="form-select form-select-custom mb-2">
            <option value="set">SETAR</option>
            <option value="inc" selected>ADICIONAR</option>
            <option value="dec">SUBTRAIR</option>
          </select>
          <label class="form-label">QTD</label>
          <input id="aAmount" type="number" value="0" class="form-control form-control-custom mb-3" />
          <div class="form-check form-switch">
             <input class="form-check-input" type="checkbox" id="aOverflow">
             <label class="form-check-label small" for="aOverflow">OVERFLOW</label>
          </div>
        `)
        confirmAction.onclick = ()=>{
          const op = document.getElementById('aOp').value
          const x = Number(document.getElementById('aAmount').value) || 0
          const allow = document.getElementById('aOverflow').checked
          applyAction(id, act, x, {op, allow})
          closeAction()
        }
      }
      cancelAction.onclick = closeAction
    }

    function closeAction(){ actionModal.classList.remove('show'); confirmAction.onclick = null; cancelAction.onclick = null }
    function actLabel(a){ return a==='dano' ? 'DMG' : a==='vida' ? 'HP' : a==='armadura' ? 'ARM' : a==='mana' ? 'MP' : a==='regen' ? 'RGN' : 'ACAO' }

    function applyAction(id, act, x, opts){
      const c = chars.find(i=>i.id===id); if(!c) return
      let tookDamage = false;
      if(act === 'dano'){
        const danoReal = !!opts
        const oldHp = c.hp; const oldArmor = c.armor;
        if(danoReal){ c.hp = Math.max(0, c.hp - x) }
        else {
          const takeArmor = Math.min(c.armor, x)
          c.armor = Math.max(0, c.armor - x)
          const leftover = x - takeArmor
          if(leftover>0) c.hp = Math.max(0, c.hp - leftover)
        }
        if (c.hp < oldHp || c.armor < oldArmor) { tookDamage = true; }
      } else if(act === 'reset'){
        if (c.initial) {
            c.hp = c.initial.hp;
            c.armor = c.initial.armor;
            c.mana = c.initial.mana;
            c.maxHp = c.initial.maxHp;
            c.maxArmor = c.initial.maxArmor;
            c.maxMana = c.initial.maxMana;
            c.regenPercent = c.initial.regenPercent;
        }
      } else if(act === 'regen'){
        const amount = Number(x) || 0
        const allow = opts && opts.allow
        c.mana = allow ? c.mana + amount : Math.min(c.maxMana, c.mana + amount)
      } else {
        const {op='inc', allow=false} = opts || {}
        const kind = act === 'vida' ? 'hp' : act === 'armadura' ? 'armor' : 'mana'
        const maxKey = act === 'vida' ? 'maxHp' : act === 'armadura' ? 'maxArmor' : 'maxMana'
        if(op === 'set'){ c[kind] = allow ? x : Math.max(0, Math.min(c[maxKey], x)) } 
        else if(op === 'inc'){ c[kind] = allow ? c[kind] + x : Math.min(c[maxKey], c[kind] + x) } 
        else if(op === 'dec'){ c[kind] = Math.max(0, c[kind] - x) }
      }
      ['hp','armor','mana','maxHp','maxArmor','maxMana','regenPercent'].forEach(k=>{ if(typeof c[k] !== 'number' || isNaN(c[k])) c[k]=0 })
      commitChange(); 
      render(); 
      if (tookDamage) { animateDamage(id); } else { animateMovedCard(id); }
    }
    
    function openResistanceModal(id) {
        const c = chars.find(x => x.id === id);
        if (!c) return;
        resistanceModalTitle.textContent = `RESIST ${c.name}`;
        resistanceModalBody.innerHTML = '';
        resistanceTypes.forEach(type => {
            const res = c.resistances[type];
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-custom d-flex justify-content-between align-items-center';
            item.dataset.type = type;
            item.innerHTML = `<span>${type}</span><span class="badge bg-secondary">${res.current}/${res.max}</span>`;
            item.onclick = () => openResistanceActionModal(id, type);
            resistanceModalBody.appendChild(item);
        });
        resistanceModal.classList.add('show');
    }
    closeResistanceModal.onclick = () => resistanceModal.classList.remove('show');

    function openResistanceActionModal(id, type) {
        activeResistanceContext = { id, type };
        resistanceActionTitle.textContent = `${type}`;
        resistanceActionModal.classList.add('show');
    }
    cancelResAction.onclick = () => resistanceActionModal.classList.remove('show');
    
    function applyResistanceAction(op) {
        const { id, type } = activeResistanceContext;
        const c = chars.find(x => x.id === id);
        if (!c) return;

        const value = Number(resAmount.value) || 0;
        const res = c.resistances[type];
        const oldValue = res.current;

        if (op === 'set') {
            res.current = Math.max(0, Math.min(res.max, value));
        } else if (op === 'add') {
            res.current = Math.min(res.max, res.current + value);
        } else if (op === 'remove') {
            res.current = Math.max(0, res.current - value);
        }
        
        if (oldValue < res.max && res.current >= res.max) {
            showToast(`${c.name} MAX ${type}!`);
        }

        commitChange();
        render();
        openResistanceModal(id);
        resistanceActionModal.classList.remove('show');
    }
    
    resSet.onclick = () => applyResistanceAction('set');
    resAdd.onclick = () => applyResistanceAction('add');
    resRemove.onclick = () => applyResistanceAction('remove');

    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-white bg-primary border-0 show';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body fw-bold">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        
        container.appendChild(toastEl);
        
        setTimeout(() => {
           toastEl.classList.remove('show');
           setTimeout(() => toastEl.remove(), 300);
        }, 3000);
    }

    function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(chars)) }
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') }catch(e){return null} }

    function populateResistanceInputs(resistances) {
        mResistances.innerHTML = '';
        resistanceTypes.forEach(type => {
            const value = resistances ? resistances[type].max : 100;
            const col = document.createElement('div');
            col.className = 'col-6';
            col.innerHTML = `
                <label class="form-label small text-muted mb-1">${type}</label>
                <input type="number" class="form-control form-control-custom form-control-sm" data-res-type="${type}" value="${value}" />
            `;
            mResistances.appendChild(col);
        });
    }

    createBtn.onclick = ()=>{
      editingId = null
      modalTitle.textContent = 'NOVO CHAR'
      mName.value = ''
      mMaxHp.value = 100
      mMaxArmor.value = 50
      mMaxMana.value = 50
      mRegenPercent.value = 10
      mDefense.value = 0
      populateResistanceInputs(null);
      deleteBtn.style.display = 'none'
      openModal()
    }

    function openEdit(id){
      editingId = id
      const c = chars.find(x=>x.id===id)
      if(!c) return
      modalTitle.textContent = 'EDIT ' + c.name
      mName.value = c.name
      mMaxHp.value = c.maxHp
      mMaxArmor.value = c.maxArmor
      mMaxMana.value = c.maxMana
      mRegenPercent.value = c.regenPercent || 0
      mDefense.value = c.defense || 0
      populateResistanceInputs(c.resistances);
      deleteBtn.style.display = 'inline-block'
      openModal()
    }
    function openModal(){ modal.classList.add('show') }
    function closeModal(){ modal.classList.remove('show'); editingId = null }

    cancelModal.onclick = ()=>{ closeModal() }

    saveModal.onclick = ()=>{
      const resistanceInputs = mResistances.querySelectorAll('input');
      const newMaxRes = {};
      resistanceInputs.forEach(input => {
          const type = input.dataset.resType;
          newMaxRes[type] = Number(input.value) || 100;
      });

      if(editingId==null){
        const resistances = createDefaultResistances();
        mResistances.querySelectorAll('input').forEach(input => {
            const type = input.dataset.resType;
            resistances[type].max = Number(input.value) || 100;
        });

        const id = Date.now()
        const name = mName.value || 'Sem nome'
        const maxHp = Number(mMaxHp.value) || 0
        const maxArmor = Number(mMaxArmor.value) || 0
        const maxMana = Number(mMaxMana.value) || 0
        const regen = Number(mRegenPercent.value) || 0
        const defense = Number(mDefense.value) || 0

        const newChar = {
            id, name, hp:maxHp, maxHp, armor:maxArmor, maxArmor, mana:maxMana, maxMana, 
            regenPercent: regen, defense,
            resistances: resistances,
            initial: {
                hp:maxHp, armor:maxArmor, mana:maxMana, maxHp, maxArmor, maxMana, 
                regenPercent: regen, defense,
                resistances: JSON.parse(JSON.stringify(resistances))
            }
        }
        chars.push(newChar)
      } else {
        const c = chars.find(x=>x.id===editingId)
        if(!c) return

        if(!c.resistances) c.resistances = createDefaultResistances();

        resistanceTypes.forEach(type => {
          const newMax = newMaxRes[type] || 100;
          if(!c.resistances[type]) c.resistances[type] = { current: 0, max: newMax };
          else c.resistances[type].max = newMax;
          c.resistances[type].current = Math.min(c.resistances[type].current || 0, c.resistances[type].max);
        });

        c.name = mName.value || c.name;
        c.maxHp = Number(mMaxHp.value) || c.maxHp;
        c.maxArmor = Number(mMaxArmor.value) || c.maxArmor;
        c.maxMana = Number(mMaxMana.value) || c.maxMana;
        c.regenPercent = Number(mRegenPercent.value) || c.regenPercent || 0;
        c.defense = Number(mDefense.value) || 0;

        c.hp = Math.min(c.hp, c.maxHp);
        c.armor = Math.min(c.armor, c.maxArmor);
        c.mana = Math.min(c.mana, c.maxMana);

        c.initial = {
            hp: c.maxHp, armor: c.maxArmor, mana: c.maxMana,
            maxHp: c.maxHp, maxArmor: c.maxArmor, maxMana: c.maxMana,
            regenPercent: c.regenPercent, defense: c.defense,
            resistances: JSON.parse(JSON.stringify(c.resistances))
        };
      }
      commitChange();
      render(); 
      closeModal()
    }

    deleteBtn.onclick = ()=>{
      if(editingId==null) return
      const c = chars.find(x=>x.id===editingId)
      if(!c) return
      if(confirm('Excluir ' + c.name + '? Isso √© permanente.')){
        chars = chars.filter(x=>x.id!==editingId)
        commitChange();
        render(); 
        closeModal()
      }
    }
    
    function setupTheme() {
        const savedTheme = localStorage.getItem('theme-preference');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
            themeSwitch.checked = true;
        }
        
        themeSwitch.addEventListener('change', () => {
            document.body.classList.toggle('light-mode');
            if (document.body.classList.contains('light-mode')) {
                localStorage.setItem('theme-preference', 'light');
            } else {
                localStorage.setItem('theme-preference', 'dark');
            }
        });
    }

    function updateUndoRedoButtons() {
        undoBtn.disabled = historyIndex <= 0;
        redoBtn.disabled = historyIndex >= history.length - 1;
    }

    function commitChange() {
        if (historyIndex < history.length - 1) {
            history.splice(historyIndex + 1);
        }
        history.push(JSON.parse(JSON.stringify(chars)));
        if (history.length > HISTORY_LIMIT) {
            history.shift();
        }
        historyIndex = history.length - 1;
        save();
        updateUndoRedoButtons();
    }

    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            chars = JSON.parse(JSON.stringify(history[historyIndex]));
            save();
            render();
            updateUndoRedoButtons();
        }
    }

    function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            chars = JSON.parse(JSON.stringify(history[historyIndex]));
            save();
            render();
            updateUndoRedoButtons();
        }
    }

    undoBtn.onclick = undo;
    redoBtn.onclick = redo;

    searchEl.oninput = ()=>render()
    window.addEventListener('keydown', e=>{ if(e.key === 'Insert'){ createBtn.click() } })

    setupTheme();
    commitChange(); 
    render();
</script>   
